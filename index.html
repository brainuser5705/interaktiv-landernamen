<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/topojson@3"></script>
        <script>

            function getGenderColor(country){
                if (country == undefined) return "black";

                switch(country.gender){
                    case "f":
                        return "lightyellow";
                        break;
                    case "m":
                        return "lightblue";
                        break;
                    case "n":
                        return "lightgreen";
                        break;
                    case "p":
                        return "pink";
                        break;
                    default:
                        return "black";
                        break;
                }
            }

            async function main(){

                var width = 1000;
                var height = 700;

                var svg = d3.select("#map")
                    .attr("width", width)
                    .attr("height", height);
                    //.attr("viewBox", [0,0,width, height]);
                    
                var g = svg.append("g")
                    .attr("transform", "translate(0, 100)");

                var projection = d3.geoMercator()
                    .scale(120);

                var map = {}

                d3.csv("landernamen.csv")
                    .then((countries) => {
                        countries.forEach((c)=>map[c.iso]=c);
                    });

                d3.json("countries-50m.json")
                    .then((world) => {

                        path = d3.geoPath().projection(projection);

                        var display = g.selectAll("path")
                            .data(topojson.feature(world, world.objects.countries).features)
                            .enter()
                            .append("path")
                            .attr("d", path)
                            .attr("stroke", "black")
                            .attr("stroke-width", 0.3)
                            .attr("fill", d=>getGenderColor(map[d.id]));
                            // .each((d, i, ns)=>{
                            //     if (!map[d.id]){
                            //         d3.select(ns[i]).attr("fill","black");
                            //         console.log(d.properties.name);
                            //     };
                            // })

                        var div = d3.select("#tooltip");
                            
                        display.on("click", (d)=>{
                                // console.log(d.properties.name);
                                console.log(map[d.id]);
                            })
                            .on("mouseover", (d,i,ns) =>{
                                let c = map[d.id];
                                d3.select(ns[i]).attr("opacity", 0.5);
                                
                                let name = "Country is not found in data";
                                let gender = "Country is not found in data";

                                if (c != undefined){
                                    switch(c.gender){
                                        case "m":
                                            name = "der " + c.vollform;
                                            gender = "Masculine";
                                            break;
                                        case "n":
                                            name = c.vollform;
                                            gender = "Neuter";
                                            break;
                                        case "f":
                                            name = "die " + c.vollform;
                                            gender = "Feminine";
                                            break;
                                        case "p":
                                            name = "die " + c.vollform;
                                            gender = "Plural";
                                        default:
                                            break;
                                    }
                                }

                                d3.select("#country-name").text(name);
                                d3.select("#country-gender").text(gender);
                                
                                // changes the same div even without remove
                                d3.select("body")
                                    .append(()=>div.node())
                                    .style("left", (d3.event.pageX + 20) + "px")
                                    .style("top", (d3.event.pageY + 20) + "px");

                                d3.select("#tooltip-name")
                                    .text(name);
                            })
                            .on("mouseout", (d,i,ns)=>{
                                d3.select(ns[i]).attr("opacity", 1);
                                div.remove();
                            });

                    });

                    var zoom = d3.zoom()
                        //.extent([0,0], [width, height])
                        .scaleExtent([1,20])
                        .on('zoom', doZoom); // need to set the bounds of translation
                    svg.call(zoom);

                    function doZoom(){
                        g.attr("transform",d3.event.transform);
                    }
            }

        </script>
    </head>
    <body onload="main()">
        <h1>Interaktiv Landernamen</h1>
        <div id="info-box">
            <label>Country name: </label> <span id="country-name"></span> <br>
            <label>Grammatical gender: </label> <span id="country-gender"></span>
        </div>
        <svg id="map" style="border: 3px solid black;">
        </svg>
        <div id="tooltip" style="position: absolute; background-color: lightgray; font-size: 10px; border: 1px solid; border-radius:8px">
            <label>Country name: </label><span id ="tooltip-name"></span>
        </div>
    </body>
</html>