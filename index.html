<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/topojson@3"></script>
        <script>

            function getGenderColor(country){
                if (country == undefined) return "black";

                switch(country.gender){
                    case "f":
                        return "lightblue";
                        break;
                    case "m":
                        return "lightpink";
                        break;
                    case "n":
                        return "plum";
                        break;
                    case "p":
                        return "white";
                        break;
                    default:
                        return "black";
                        break;
                }
            }

            async function main(){
                var svg = d3.select("#map");
                var g = svg.append("g")
                    .attr("transform", "translate(0, 100)");

                var projection = d3.geoMercator()
                    .scale(120);

                var map = {}

                d3.csv("landernamen.csv")
                    .then((countries) => {
                        countries.forEach((c)=>map[c.iso]=c);
                    });

                d3.json("countries-50m.json")
                    .then((world) => {

                        path = d3.geoPath().projection(projection);

                        g.selectAll("path")
                            .data(topojson.feature(world, world.objects.countries).features)
                            .enter()
                            .append("path")
                            .attr("d", path)
                            .attr("stroke", "black")
                            .attr("stroke-width", 0.3)
                            .attr("fill", d=>getGenderColor(map[d.id]))
                            // .each((d, i, ns)=>{
                            //     if (!map[d.id]){
                            //         d3.select(ns[i]).attr("fill","lightblue");
                            //         console.log(d.properties.name);
                            //     };
                            // })
                            .on("click", (d)=>{
                                // console.log(d.properties.name);
                                console.log(map[d.id]);
                            })
                            .on("mouseover", (d,i,ns) =>{
                                let c = map[d.id];
                                d3.select(ns[i]).attr("fill", "gray");
                                
                                let name = "Country is not found in data";
                                let gender = "Country is not found in data";

                                if (c != undefined){
                                    switch(c.gender){
                                        case "m":
                                            name = "der " + c.vollform;
                                            gender = "Masculine";
                                            break;
                                        case "n":
                                            name = c.vollform;
                                            gender = "Neuter";
                                            break;
                                        case "f":
                                            name = "die " + c.vollform;
                                            gender = "Feminine";
                                            break;
                                        default:
                                            break;
                                    }
                                }

                                d3.select("#country-name").text(name);
                                d3.select("#country-gender").text(gender);
                            })
                            .on("mouseout", (d,i,ns)=>{
                                d3.select(ns[i]).attr("fill", d=>getGenderColor(map[d.id]));
                            });

                    });

                    var zoom = d3.zoom()
                        .scaleExtent([1,20])
                        .on('zoom', doZoom); // need to set the bounds of translation
                    svg.call(zoom);

                    function doZoom(){
                        g.attr("transform",d3.event.transform);
                    }
            }

        </script>
    </head>
    <body onload="main()">
        <h1>Interaktiv Landernamen</h1>
        <div id="info-box">
            <label>Country name: </label> <span id="country-name"></span> <br>
            <label>Grammatical gender: </label> <span id="country-gender"></span>
        </div>
        <svg id="map" width="1000" height="700" style="border: 3px solid black;">
        </svg>
    </body>
</html>